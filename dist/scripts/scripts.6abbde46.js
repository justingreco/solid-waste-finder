"use strict";angular.module("solidWasteFinderApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","geolocation"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter,{event:b})}),b.preventDefault())})}}),angular.module("solidWasteFinderApp").controller("MainCtrl",["$scope","$http","$timeout","geolocation",function(a,b,c,d){var e,f,g,h,i;a.features=[],a.userType="resident",a.showDistance=!1,a.searchByLocation=function(a){/^\d+$/.test(a)&&5===a.length?n(a):o(a)},a.getLocation=function(){a.geolocating=!0,d.getLocation().then(function(b){console.log(b),a.geolocating=!1,g={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[b.coords.longitude,b.coords.latitude]}},j([b.coords.latitude,b.coords.longitude]),a.query(),f.bindPopup(function(a){return L.Util.template('<strong>{OPERATOR}</strong><br/>{TYPE}<br/>{ADDRESS}<br/>{HOURS}<strong><br/>{OPENTO}<br/><a href="'+m(g.geometry.coordinates,a.geometry.coordinates)+'">Directions</a>',a.properties)})})},a.query=function(){console.log("query");var b=[],c="";if(a.material){var d="'"+a.material.categories.toString().replace(/,/g,"','")+"'";b.push("CATEGORY IN ("+d+")")}"resident"===a.userType?b.push("OPENTO IN ('Residents and Businesses', 'Residents only')"):"business"===a.userType&&b.push("OPENTO IN ('Residents and Businesses', 'Businesses only')"),c=0===b.length?"1=1":1===b.length?b[0]:b[0]+" AND "+b[1],f.query().where(c).run(function(b,c){g&&(l(g,c),a.features=k(g,c.features)),a.features=c.features,a.$$phase||a.$digest()}),f.setWhere(c)},a.userTypeChanged=function(){c(function(){a.query()})},a.tableRowClicked=function(a){e.setView([a.geometry.coordinates[1],a.geometry.coordinates[0]],16)};var j=function(a){var b=L.icon({iconUrl:"images/location.01de4869.png",iconSize:[14,14]});h.clearLayers(),h.addLayer(L.marker(a,{icon:b}))},k=function(b,c){return a.showDistance=!0,angular.forEach(c,function(a){var c=turf.distance(b,a,"miles");console.log(a.geometry.coordinates),console.log(c),a.properties.DISTANCE=c}),c},l=function(a,b){var c,d=turf.nearest(a,b),f=L.geoJson(a).getBounds();f=f.extend(L.geoJson(d).getBounds()),e.fitBounds([f],{padding:[135,135]}),i.clearLayers();var g=L.AwesomeMarkers.icon({icon:"trash",markerColor:"red"});c=L.marker([d.geometry.coordinates[1],d.geometry.coordinates[0]],{icon:g,zIndexOffset:100}).bindPopup("<strong>"+d.properties.OPERATOR+"</strong><br/>"+d.properties.TYPE+"<br/>"+d.properties.ADDRESS+"<br/>"+d.properties.HOURS+"<strong><br/>"+d.properties.OPENTO+'<br/><a href="'+m(a.geometry.coordinates,d.geometry.coordinates)+'">Directions</a>'),i.addLayer(c),c.openPopup()},m=function(a,b){return"https://www.google.com/maps/dir/"+a[1]+","+a[0]+"/"+b[1]+","+b[0]},n=function(b){var c=L.esri.Tasks.query({url:"https://maps.raleighnc.gov/arcgis/rest/services/Boundaries/MapServer/12"});c.where("ZIPNUM = "+b),c.run(["error","featureCollection",function(b,c){var d=turf.centroid(c);g=d,j([d.geometry.coordinates[1],d.geometry.coordinates[0]]),a.query()}])},o=function(c){b({url:"https://maps.raleighnc.gov/arcgis/rest/services/Locators/Locator/GeocodeServer/findAddressCandidates",method:"GET",params:{"Single Line Input":c,outSR:4326,f:"json"}}).success(function(b){if(b.candidates.length>0){var c=L.esri.Util.arcgisToGeojson(b.candidates[0].location);c={type:"Feature",properties:{},geometry:c},g=c,j([c.geometry.coordinates[1],c.geometry.coordinates[0]]),a.query()}})},p=function(){e=L.map("map").setView([35.8,-78.64447],10),L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'}).addTo(e),f=L.esri.featureLayer("http://maps.wakegov.com/arcgis/rest/services/Environmental/SWFacilities/MapServer/0",{cacheLayers:!1,pointToLayer:function(a,b){var c,d="blue";switch(a.properties.CATEGORY){case"multimaterial":d="green";break;case"convenience":d="blue";break;case"municipal":d="purple";break;case"household":d="orange"}return c=L.AwesomeMarkers.icon({icon:"trash",markerColor:d}),L.marker(b,{icon:c})}}).addTo(e),L.esri.featureLayer("http://maps.raleighnc.gov/arcgis/rest/services/BaseMapBasic/MapServer/0",{style:function(a){return{color:"black",weight:2,fillOpacity:0,opacity:.1}}}).addTo(e),f.bindPopup(function(a){return L.Util.template("<strong>{OPERATOR}</strong><br/>{TYPE}<br/>{ADDRESS}<br/>{HOURS}<strong><br/>{OPENTO}",a.properties)}),a.query(),h=L.featureGroup().addTo(e),i=L.featureGroup().addTo(e)},q=function(){b.get("data/materials.json").success(function(b){a.materials=b})};q(),p()}]);